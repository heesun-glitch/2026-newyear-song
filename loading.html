<script>
    const userKeyword = localStorage.getItem('userKeyword') || "Hope"; 
    const userWish = localStorage.getItem('userWish') || "Happy New Year";
    const isKorean = navigator.language.includes('ko');

    window.onload = function() {
        if (!isKorean) { 
            document.getElementById('loadingTitle').innerText = "Analyzing your wish..."; 
        }
        fetchAIRecommendation();
    };

    async function fetchAIRecommendation() {
        if (typeof gtag === 'function') { 
            gtag('event', 'ai_request', { 'search_term': userKeyword, 'user_wish': userWish }); 
        }

        // ★★★ 완전히 초기화된, 본질에 집중한 프롬프트 ★★★
        let systemInstruction = isKorean 
            ? `너는 2026년 새해를 열어주는 DJ야.
               
               [미션]
               사용자가 선택한 키워드("${userKeyword}")와 적은 소원("${userWish}")의 내용을 깊이 분석해줘.
               그리고 이 사람에게 힘이 되어줄 수 있는 **긍정적이고 희망찬 노래** 하나를 추천해줘.
               
               [조건]
               1. 장르 불문(K-Pop, 팝송 등)이지만, **반드시 음원 사이트에 실존하는 노래**여야 해. (없는 노래 지어내지 말 것)
               2. 노래 제목과 가수가 정확해야 해.
               3. 추천 이유는 사용자의 소원과 연결지어서 따뜻하게(해요체) 작성해줘. (마지막은 '허허'로 마무리)
               
               [출력 형식 (JSON)]
               {"title": "노래제목", "artist": "가수", "reason": "추천이유"}
               * 이미지 URL은 절대 넣지 마.` 
            : `You are a DJ for 2026.
               
               [Mission]
               Analyze the user's keyword "${userKeyword}" and wish "${userWish}".
               Recommend one **Positive and Hopeful song** that fits their wish perfectly.
               
               [Conditions]
               1. Any genre is fine, but it MUST be a **Real Song** that exists. (Do not hallucinate)
               2. Use exact Title and Artist name.
               
               [Format (JSON)]
               {"title": "Title", "artist": "Artist", "reason": "Reason (Warm tone, end with 'huh-huh')"}
               * No image URL.`;

        try {
            const response = await fetch("/api/generate", { 
                method: "POST", 
                headers: { "Content-Type": "application/json" }, 
                body: JSON.stringify({ systemInstruction }) 
            });

            if (!response.ok) throw new Error("Server Error");

            const data = await response.json();
            const aiContent = data.choices ? data.choices[0].message.content : JSON.stringify(data);
            const result = JSON.parse(aiContent);
            
            location.replace(`result.html?t=${encodeURIComponent(result.title)}&a=${encodeURIComponent(result.artist)}&r=${encodeURIComponent(result.reason)}&w=${encodeURIComponent(userWish)}&img=${encodeURIComponent(result.img_url)}`);

        } catch (error) { 
            console.error(error);
            alert("오류가 발생했습니다. 잠시 후 다시 시도해 주세요.");
            location.href = 'index.html'; 
        }
    }
</script>